"use strict";var gapiPromise,registerPromise;function pause(e){return new Promise((t=>setTimeout(t,e)))}function isSignedIn(){var e=window.gapi&&gapi.auth2&&gapi.auth2.getAuthInstance();return e&&e.isSignedIn.get()&&e}function signIn(){return new Promise(((e,t)=>{var r=window.gapi&&gapi.auth2&&gapi.auth2.getAuthInstance();if(!r)return pause(1500).then((()=>e(signIn())));r.then((()=>{r.isSignedIn.get()?e():(gapiPromise||(gapiPromise=r.signIn()),gapiPromise.then((()=>{gapiPromise=null,loadUser(),e()})).catch((()=>{gapiPromise=null,t()})))})).catch((()=>t()))}))}function errorHandler(e){e.statusText||e.errorMsg?alert("Error: "+e.statusText+"\n\n"+e.errorMsg):console.error(e)}function newRegisterPromise(){return new Promise(((e,t)=>{document.body.insertAdjacentHTML("afterbegin",'<div class="modal">\n\t\t\t<div class="modal-content"><span class="close">&times;</span><div class="modal-inner"></div></div>\n\t\t</div>');let r=document.querySelector(".modal"),n=r.querySelector(".modal-inner");n.innerHTML='<h3>Formulario de registro</h3>\n\t\t<form>\n\t\t\t<table>\n\t\t\t\t<tr><td>Nombre de usuario</td></tr>\n\t\t\t\t<tr><td><input type="text" name="username" required></td></tr>\n\t\t\t\t<tr><td><input type="submit" value="Registrarse"></td></tr>\n\t\t\t</table>\n\t\t</form>';let s=n.querySelector("form");s.onsubmit=function(t){return post("/register",{username:s.username.value},!0).then((()=>{r.parentNode.removeChild(r),e()})).catch(errorHandler),!1},r.querySelector(".close").onclick=function(){r.parentNode.removeChild(r),t()}}))}function request(e,t,r,n=!1){return new Promise(((s,i)=>{let o=new XMLHttpRequest;if(o.open(e,t),o.responseType="json","POST"==e&&o.setRequestHeader("Content-type","application/json"),n){var u;if(!(u=isSignedIn()))return signIn().then((()=>{s(request(e,t,r,n))})).catch((()=>{i({statusText:"Unauthorized",errorMsg:"Sign in required"})}));o.setRequestHeader("Authorization","Bearer "+u.currentUser.get().getAuthResponse().id_token)}o.onload=function(){o.status>=400?o.response&&o.response.error?"Registration required"==o.response.error?(registerPromise||(registerPromise=newRegisterPromise()),registerPromise.then((()=>{registerPromise=null,loadUser(),s(request(e,t,r,n))})).catch((()=>{registerPromise=null,i({statusText:o.statusText,errorMsg:"Registration required"})}))):"Invalid token"==o.response.error?signIn().then((()=>{s(request(e,t,r,n))})).catch((()=>{i({statusText:"Unauthorized",errorMsg:"Sign in required"})})):i({statusText:o.statusText,errorMsg:o.response.error}):i({statusText:o.statusText,errorMsg:JSON.stringify(o.response,null,3)}):s(o.response)},o.onerror=()=>i({statusText:o.statusText,errorMsg:"Request failed"}),o.send(JSON.stringify(r))}))}function get(e,t=!1){return request("GET",e,null,t)}function post(e,t,r=!1){return request("POST",e,t,r)}