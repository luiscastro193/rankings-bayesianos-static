'use strict';if(location.protocol=='http:')location.protocol='https:';var posColor={r:45,g:156,b:149};var negColor={r:195,g:69,b:104};var transparency=0.15;var postLimit=10;function loadUser(){document.getElementById('welcomeMsg').innerHTML='';document.getElementById('signOut').innerHTML='';get('/username',true).then(function(username){document.getElementById('welcomeMsg').textContent='Bienvenido, '+username+'.';document.getElementById('signOut').textContent='Log out'}).catch(function(){});localStorage.cookie='true'}function clearUser(){gapi.auth2.getAuthInstance().signOut();localStorage.removeItem('cookie');location.reload()}function goTo(uri,event){if(event&&(event.ctrlKey||event.metaKey||event.shiftKey))return true;uri=uri.substr(uri.lastIndexOf('#')+1);if(location.hash.substr(1)==uri)loadURI();else location.hash=uri;return false}document.addEventListener('click',function(event){if(event.target.nodeName.toLowerCase()=='a')return false});function postIssue(form){var button=form.querySelector('.propose-button');button.disabled=true;button.value='Proponiendo...';post('/issue',{content:form.elements.issueText.value},true).then(function(){goTo('#/new')}).catch(function(error){errorHandler(error);button.value='Proponer';button.disabled=false})}function postAnswer(form,issueid){var button=form.querySelector('.propose-button');button.disabled=true;button.value='Proponiendo...';post('/answer',{issueid:issueid,content:form.elements.answerText.value},true).then(function(){goTo('#/issue/'+issueid+'/new')}).catch(function(error){errorHandler(error);button.value='Proponer';button.disabled=false})}function setColors(postNode,score){var posMultiplier=Math.max(0,Math.min(score,100))/100;var negMultiplier=1-posMultiplier;var rgb=(posColor.r*posMultiplier+negColor.r*negMultiplier).toFixed()+', '+(posColor.g*posMultiplier+negColor.g*negMultiplier).toFixed()+', '+(posColor.b*posMultiplier+negColor.b*negMultiplier).toFixed();postNode.querySelector('[name=score]').style.color='rgb('+rgb+')';postNode.style.borderColor='rgb('+rgb+')';postNode.style.backgroundColor='rgba('+rgb+', '+transparency+')'}function setLinks(postNode,vote,order){var funct=arguments.length>3&&arguments[3]!==undefined?arguments[3]:rateIssue;var positive=postNode.querySelector('.positive');var negative=postNode.querySelector('.negative');if(vote===true){positive.style.fontWeight='bold';negative.style.fontWeight='normal';positive.querySelector('a').onclick=function(){funct(postNode,null,order)};negative.querySelector('a').onclick=function(){funct(postNode,false,order)}}else if(vote===false){positive.style.fontWeight='normal';negative.style.fontWeight='bold';positive.querySelector('a').onclick=function(){funct(postNode,true,order)};negative.querySelector('a').onclick=function(){funct(postNode,null,order)}}else{positive.style.fontWeight='normal';negative.style.fontWeight='normal';positive.querySelector('a').onclick=function(){funct(postNode,true,order)};negative.querySelector('a').onclick=function(){funct(postNode,false,order)}}}function rateIssue(issue,vote,order){var chosenScore=void 0;switch(order){case'promising':chosenScore='promisingScore';break;case'consolidated':chosenScore='consolidatedScore';break;default:chosenScore='score';}post('/issue-vote',{issueid:issue.issueid,vote:vote},true).then(function(scores){var newScore=scores[chosenScore];issue.querySelector('[name=score]').textContent=newScore.toFixed();setColors(issue,newScore);setLinks(issue,vote,order);issue.querySelector('[name=trues]').textContent=scores.trues;issue.querySelector('[name=falses]').textContent=scores.falses}).catch(errorHandler)}function rateAnswer(answer,vote,order){var chosenScore=void 0;switch(order){case'promising':chosenScore='promisingScore';break;case'consolidated':chosenScore='consolidatedScore';break;default:chosenScore='score';}post('/answer-vote',{answerid:answer.answerid,vote:vote},true).then(function(scores){var newScore=scores[chosenScore];answer.querySelector('[name=score]').textContent=newScore.toFixed();setColors(answer,newScore);setLinks(answer,vote,order,rateAnswer);answer.querySelector('[name=trues]').textContent=scores.trues;answer.querySelector('[name=falses]').textContent=scores.falses}).catch(errorHandler)}function seeMore(element){var p=element.previousSibling;if(p.style.maxHeight)p.style.maxHeight=parseInt(p.style.maxHeight)+30+'em';else p.style.maxHeight='30em';if(p.offsetHeight>=p.scrollHeight)element.parentNode.removeChild(element)}function loadIssues(){var order=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'promising';var offset=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;document.title='Rankings bayesianos';document.querySelector('main').innerHTML='<section class=\'order-bar\'>\n\t\t<a id="newLink" href="#/new" onclick="return goTo(this.href, event)">Nuevas</a>\n\t\t<a id="promisingLink" href="#/promising" onclick="return goTo(this.href, event)">Prometedoras</a>\n\t\t<a id="bestLink" href="#/best" onclick="return goTo(this.href, event)">Mejores</a>\n\t\t<a id="consolidatedLink" href="#/consolidated" onclick="return goTo(this.href, event)">Consolidadas</a>\n\t</section>\n\t<section class=\'posts-box\'>\n\t\t<form class=\'post-form\' onsubmit="postIssue(this); return false">\n\t\t\t<textarea class=\'post-input\' name="issueText" rows=4 oninput="while (this.offsetHeight <= this.scrollHeight) this.rows += 4"\n\t\t\t\tplaceholder="Prop\xF3n una nueva cuesti\xF3n..." required></textarea>\n\t\t\t<input class="propose-button" type="submit" value="Proponer">\n\t\t</form>\n\t</section>';document.getElementById(order+'Link').style.fontWeight='bold';var form=document.querySelector('form');get('/issues/'+order+'?offset='+offset,isSignedIn()).then(function(issues){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=issues.issues[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var issue=_step.value;form.insertAdjacentHTML('beforebegin','<article>\n\t\t\t\t<p class=\'post-content\'><a href="#/issue/'+issue.issueid+'" onclick="return goTo(this.href, event)"></a></p>\n\t\t\t\t<p class=\'post-info\'></p>\n\t\t\t\t<section class=\'voting-box\'>\n\t\t\t\t\t<p class=\'positive\'><a class=\'positive\' href="javascript:void(0)">A favor</a> (<span name=\'trues\'>'+issue.trues+'</span>)</p>\n\t\t\t\t\t<p class=\'negative\'><a class=\'negative\' href="javascript:void(0)">En contra</a> (<span name=\'falses\'>'+issue.falses+'</span>)</p>\n\t\t\t\t\t<p>Puntuaci\xF3n: <span name=\'score\'>'+issue.chosen_score.toFixed()+'</span></p>\n\t\t\t\t</section>\n\t\t\t</article>');var issueNode=form.previousSibling;issueNode.issueid=issue.issueid;var content=issueNode.querySelector('.post-content');var info=issueNode.querySelector('.post-info');content.querySelector('a').textContent=issue.content;info.textContent=moment(issue.created_at).fromNow()+' por '+issue.username;if(content.offsetHeight<content.scrollHeight){content.insertAdjacentHTML('afterend','<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver m\xE1s</a><p>');if(content.scrollHeight<=content.offsetHeight+content.nextSibling.scrollHeight)content.nextSibling.firstChild.click()}if(info.offsetHeight<info.scrollHeight){info.insertAdjacentHTML('afterend','<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver m\xE1s</a><p>');if(info.scrollHeight<=info.offsetHeight+info.nextSibling.scrollHeight)info.nextSibling.firstChild.click()}setLinks(issueNode,issue.vote,order);setColors(issueNode,issue.chosen_score)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}if(issues.more)form.insertAdjacentHTML('afterend','<button class=\'load-more\' onclick="loadIssues(\''+order+'\', '+(offset+postLimit)+'); history.pushState({offset: '+(offset+postLimit)+'}, \'\')">Cargar siguientes</button>')}).catch(errorHandler)}function loadAnswers(issueid,order){var offset=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var form=document.querySelector('form');form.parentNode.removeChild(form.nextSibling);while(form.previousSibling){form.parentNode.removeChild(form.previousSibling)}get('/issue/'+issueid+'/answers/'+order+'?offset='+offset,isSignedIn()).then(function(answers){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=answers.answers[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var answer=_step2.value;form.insertAdjacentHTML('beforebegin','<article>\n\t\t\t\t<p class=\'post-content\'></p>\n\t\t\t\t<p class=\'post-info\'></p>\n\t\t\t\t<section class=\'voting-box\'>\n\t\t\t\t\t<p class=\'positive\'><a class=\'positive\' href="javascript:void(0)">A favor</a> (<span name=\'trues\'>'+answer.trues+'</span>)</p>\n\t\t\t\t\t<p class=\'negative\'><a class=\'negative\' href="javascript:void(0)">En contra</a> (<span name=\'falses\'>'+answer.falses+'</span>)</p>\n\t\t\t\t\t<p>Puntuaci\xF3n: <span name=\'score\'>'+answer.chosen_score.toFixed()+'</span></p>\n\t\t\t\t</section>\n\t\t\t</article>');var answerNode=form.previousSibling;answerNode.answerid=answer.answerid;var content=answerNode.querySelector('.post-content');var info=answerNode.querySelector('.post-info');content.textContent=answer.content;info.textContent=moment(answer.created_at).fromNow()+' por '+answer.username;if(content.offsetHeight<content.scrollHeight){content.insertAdjacentHTML('afterend','<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver m\xE1s</a><p>');if(content.scrollHeight<=content.offsetHeight+content.nextSibling.scrollHeight)content.nextSibling.firstChild.click()}if(info.offsetHeight<info.scrollHeight){info.insertAdjacentHTML('afterend','<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver m\xE1s</a><p>');if(info.scrollHeight<=info.offsetHeight+info.nextSibling.scrollHeight)info.nextSibling.firstChild.click()}setLinks(answerNode,answer.vote,order,rateAnswer);setColors(answerNode,answer.chosen_score)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}if(answers.more)form.insertAdjacentHTML('afterend','<button class=\'load-more\' onclick="loadAnswers(\''+issueid+'\', \''+order+'\', '+(offset+postLimit)+'); history.pushState({offset: '+(offset+postLimit)+'}, \'\')">Cargar siguientes</button>')}).catch(errorHandler)}function loadIssue(issueid){var order=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'promising';var offset=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;document.querySelector('main').innerHTML='<section class=\'order-bar\'>\n\t\t<a id="newLink" href="#/issue/'+issueid+'/new" onclick="return goTo(this.href, event)">Nuevas</a>\n\t\t<a id="promisingLink" href="#/issue/'+issueid+'/promising" onclick="return goTo(this.href, event)">Prometedoras</a>\n\t\t<a id="bestLink" href="#/issue/'+issueid+'/best" onclick="return goTo(this.href, event)">Mejores</a>\n\t\t<a id="consolidatedLink" href="#/issue/'+issueid+'/consolidated" onclick="return goTo(this.href, event)">Consolidadas</a>\n\t</section>\n\t<section class=\'posts-box\'>\n\t\t<form class=\'post-form\' onsubmit="postAnswer(this, \''+issueid+'\'); return false">\n\t\t\t<textarea class=\'post-input\' name="answerText" rows=4 oninput="while (this.offsetHeight <= this.scrollHeight) this.rows += 4"\n\t\t\t\tplaceholder="Prop\xF3n una nueva respuesta..." required></textarea>\n\t\t\t<input class="propose-button" type="submit" value="Proponer">\n\t\t</form>\n\t</section>';document.getElementById(order+'Link').style.fontWeight='bold';var orderBar=document.querySelector('.order-bar');get('/issue/'+issueid,isSignedIn()).then(function(issue){document.title=issue.content+' - Ranking bayesianos';orderBar.insertAdjacentHTML('beforebegin','<section class=\'posts-box\'>\n\t\t\t<article>\n\t\t\t\t<p class=\'post-content\'></p>\n\t\t\t\t<p class=\'post-info\'></p>\n\t\t\t\t<section class=\'voting-box\'>\n\t\t\t\t\t<p class=\'positive\'><a class=\'positive\' href="javascript:void(0)">A favor</a> (<span name=\'trues\'>'+issue.trues+'</span>)</p>\n\t\t\t\t\t<p class=\'negative\'><a class=\'negative\' href="javascript:void(0)">En contra</a> (<span name=\'falses\'>'+issue.falses+'</span>)</p>\n\t\t\t\t\t<p>Puntuaci\xF3n: <span name=\'score\'>'+issue.score.toFixed()+'</span></p>\n\t\t\t\t</section>\n\t\t\t</article>\n\t\t</section>');var issueNode=orderBar.previousSibling.querySelector('article');issueNode.issueid=issueid;var content=issueNode.querySelector('.post-content');var info=issueNode.querySelector('.post-info');content.textContent=issue.content;info.textContent=moment(issue.created_at).fromNow()+' por '+issue.username;if(content.offsetHeight<content.scrollHeight)content.insertAdjacentHTML('afterend','<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver m\xE1s</a><p>');if(info.offsetHeight<info.scrollHeight)info.insertAdjacentHTML('afterend','<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver m\xE1s</a><p>');setLinks(issueNode,issue.vote);setColors(issueNode,issue.score)}).catch(errorHandler);loadAnswers(issueid,order,offset)}function loadURI(event){var uri=location.hash.split('/');var offset=event&&event.state&&event.state.offset||0;if(uri.length>2){if(uri[3]=='new'||uri[3]=='promising'||uri[3]=='best'||uri[3]=='consolidated')loadIssue(uri[2],uri[3],offset);else loadIssue(uri[2],undefined,offset)}else if(uri[1]=='new'||uri[1]=='promising'||uri[1]=='best'||uri[1]=='consolidated')loadIssues(uri[1],offset);else loadIssues(undefined,offset)}window.onpopstate=loadURI;function onLogin(){loadUser();loadURI()}document.addEventListener('DOMContentLoaded',function(event){if(localStorage.cookie){signIn().then(function(){if(document.querySelector('.default-msg'))loadURI()}).catch(function(){localStorage.removeItem('cookie');loadURI()})}else loadURI()});
