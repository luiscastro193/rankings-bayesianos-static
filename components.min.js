"use strict";"http:"==location.protocol&&"localhost"!=location.hostname&&(location.protocol="https:");const posColor={r:45,g:156,b:149},negColor={r:195,g:69,b:104},transparency=.15,postLimit=10;function loadUser(){document.getElementById("welcomeMsg").innerHTML="",document.getElementById("signOut").innerHTML="",get("/username",!0).then((e=>{document.getElementById("welcomeMsg").textContent=`Bienvenido/a, ${e}.`,document.getElementById("signOut").textContent="Log out"})).catch((()=>{})),localStorage.cookie="true"}function clearUser(){gapi.auth2.getAuthInstance().signOut(),localStorage.removeItem("cookie"),location.reload()}function goTo(e,t){if(t&&(t.ctrlKey||t.metaKey||t.shiftKey||t.which>1))return!0;e=e.substr(e.lastIndexOf("#")+1),location.hash.substr(1)==e?loadURI():location.hash=e,t&&t.preventDefault()}function postIssue(e){let t=e.querySelector(".propose-button");t.disabled=!0,t.value="Proponiendo...",post("/issue",{content:e.elements.issueText.value},!0).then((()=>{goTo("#/new")})).catch((e=>{errorHandler(e),t.value="Proponer",t.disabled=!1}))}function postAnswer(e,t){let o=e.querySelector(".propose-button");o.disabled=!0,o.value="Proponiendo...",post("/answer",{issueid:t,content:e.elements.answerText.value},!0).then((()=>{goTo(`#/issue/${t}/new`)})).catch((e=>{errorHandler(e),o.value="Proponer",o.disabled=!1}))}function setColors(e,t){let o=Math.max(0,Math.min(t,100))/100,s=1-o,n=`${(posColor.r*o+negColor.r*s).toFixed()}, ${(posColor.g*o+negColor.g*s).toFixed()}, ${(posColor.b*o+negColor.b*s).toFixed()}`;e.querySelector("[name=score]").style.color=`rgb(${n})`,e.style.borderColor=`rgb(${n})`,e.style.backgroundColor=`rgba(${n}, 0.15)`}function setLinks(e,t,o,s=rateIssue){let n=e.querySelector(".positive"),r=e.querySelector(".negative");!0===t?(n.style.fontWeight="bold",r.style.fontWeight="normal",n.querySelector("a").onclick=function(){s(e,null,o)},r.querySelector("a").onclick=function(){s(e,!1,o)}):!1===t?(n.style.fontWeight="normal",r.style.fontWeight="bold",n.querySelector("a").onclick=function(){s(e,!0,o)},r.querySelector("a").onclick=function(){s(e,null,o)}):(n.style.fontWeight="normal",r.style.fontWeight="normal",n.querySelector("a").onclick=function(){s(e,!0,o)},r.querySelector("a").onclick=function(){s(e,!1,o)})}function rateIssue(e,t,o){let s;switch(o){case"promising":s="promisingScore";break;case"consolidated":s="consolidatedScore";break;default:s="score"}post("/issue-vote",{issueid:e.issueid,vote:t},!0).then((n=>{let r=n[s];e.querySelector("[name=score]").textContent=r.toFixed(),setColors(e,r),setLinks(e,t,o),e.querySelector("[name=trues]").textContent=n.trues,e.querySelector("[name=falses]").textContent=n.falses})).catch(errorHandler)}function rateAnswer(e,t,o){let s;switch(o){case"promising":s="promisingScore";break;case"consolidated":s="consolidatedScore";break;default:s="score"}post("/answer-vote",{answerid:e.answerid,vote:t},!0).then((n=>{let r=n[s];e.querySelector("[name=score]").textContent=r.toFixed(),setColors(e,r),setLinks(e,t,o,rateAnswer),e.querySelector("[name=trues]").textContent=n.trues,e.querySelector("[name=falses]").textContent=n.falses})).catch(errorHandler)}function seeMore(e){let t=e.previousSibling;t.style.maxHeight?t.style.maxHeight=parseInt(t.style.maxHeight)+30+"em":t.style.maxHeight="30em",t.offsetHeight>=t.scrollHeight&&e.parentNode.removeChild(e)}function loadIssues(e="promising",t=0){document.title="Rankings bayesianos",document.querySelector("main").innerHTML='<section class=\'order-bar\'>\n\t\t<a id="newLink" href="#/new">Nuevas</a>\n\t\t<a id="promisingLink" href="#/promising">Prometedoras</a>\n\t\t<a id="bestLink" href="#/best">Mejores</a>\n\t\t<a id="consolidatedLink" href="#/consolidated">Consolidadas</a>\n\t</section>\n\t<section class=\'posts-box\'>\n\t\t<form class=\'post-form\' onsubmit="postIssue(this); return false">\n\t\t\t<textarea class=\'post-input\' name="issueText" rows=4 oninput="while (this.offsetHeight <= this.scrollHeight) this.rows += 4"\n\t\t\t\tplaceholder="Propón una nueva cuestión..." required></textarea>\n\t\t\t<input class="propose-button" type="submit" value="Proponer">\n\t\t</form>\n\t</section>',document.getElementById(e+"Link").style.fontWeight="bold";let o=document.querySelector("form");get("/issues/"+e+"?offset="+t,isSignedIn()).then((s=>{for(let t of s.issues){o.insertAdjacentHTML("beforebegin",`<article>\n\t\t\t\t<p class='post-content'><a href="#/issue/${t.issueid}"></a></p>\n\t\t\t\t<p class='post-info'></p>\n\t\t\t\t<section class='voting-box'>\n\t\t\t\t\t<p class='positive'><a class='positive' href="javascript:void(0)">A favor</a> (<span name='trues'>${t.trues}</span>)</p>\n\t\t\t\t\t<p class='negative'><a class='negative' href="javascript:void(0)">En contra</a> (<span name='falses'>${t.falses}</span>)</p>\n\t\t\t\t\t<p>Puntuación: <span name='score'>${t.chosen_score.toFixed()}</span></p>\n\t\t\t\t</section>\n\t\t\t</article>`);let s=o.previousSibling;s.issueid=t.issueid;let n=s.querySelector(".post-content"),r=s.querySelector(".post-info");n.querySelector("a").textContent=t.content,r.textContent=`${moment(t.created_at).fromNow()} por ${t.username}`,n.offsetHeight<n.scrollHeight&&(n.insertAdjacentHTML("afterend",'<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver más</a><p>'),n.scrollHeight<=n.offsetHeight+n.nextSibling.scrollHeight&&n.nextSibling.firstChild.click()),r.offsetHeight<r.scrollHeight&&(r.insertAdjacentHTML("afterend",'<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver más</a><p>'),r.scrollHeight<=r.offsetHeight+r.nextSibling.scrollHeight&&r.nextSibling.firstChild.click()),setLinks(s,t.vote,e),setColors(s,t.chosen_score)}s.more&&o.insertAdjacentHTML("afterend",`<button class='load-more' onclick="loadIssues('${e}', ${t+10}); history.pushState({offset: ${t+10}}, '')">Cargar siguientes</button>`)})).catch(errorHandler)}function loadAnswers(e,t,o=0){let s=document.querySelector("form");for(s.parentNode.removeChild(s.nextSibling);s.previousSibling;)s.parentNode.removeChild(s.previousSibling);get("/issue/"+e+"/answers/"+t+"?offset="+o,isSignedIn()).then((n=>{for(let e of n.answers){s.insertAdjacentHTML("beforebegin",`<article>\n\t\t\t\t<p class='post-content'></p>\n\t\t\t\t<p class='post-info'></p>\n\t\t\t\t<section class='voting-box'>\n\t\t\t\t\t<p class='positive'><a class='positive' href="javascript:void(0)">A favor</a> (<span name='trues'>${e.trues}</span>)</p>\n\t\t\t\t\t<p class='negative'><a class='negative' href="javascript:void(0)">En contra</a> (<span name='falses'>${e.falses}</span>)</p>\n\t\t\t\t\t<p>Puntuación: <span name='score'>${e.chosen_score.toFixed()}</span></p>\n\t\t\t\t</section>\n\t\t\t</article>`);let o=s.previousSibling;o.answerid=e.answerid;let n=o.querySelector(".post-content"),r=o.querySelector(".post-info");n.textContent=e.content,r.textContent=`${moment(e.created_at).fromNow()} por ${e.username}`,n.offsetHeight<n.scrollHeight&&(n.insertAdjacentHTML("afterend",'<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver más</a><p>'),n.scrollHeight<=n.offsetHeight+n.nextSibling.scrollHeight&&n.nextSibling.firstChild.click()),r.offsetHeight<r.scrollHeight&&(r.insertAdjacentHTML("afterend",'<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver más</a><p>'),r.scrollHeight<=r.offsetHeight+r.nextSibling.scrollHeight&&r.nextSibling.firstChild.click()),setLinks(o,e.vote,t,rateAnswer),setColors(o,e.chosen_score)}n.more&&s.insertAdjacentHTML("afterend",`<button class='load-more' onclick="loadAnswers('${e}', '${t}', ${o+10}); history.pushState({offset: ${o+10}}, '')">Cargar siguientes</button>`)})).catch(errorHandler)}function loadIssue(e,t="promising",o=0){document.querySelector("main").innerHTML=`<section class='order-bar'>\n\t\t<a id="newLink" href="#/issue/${e}/new">Nuevas</a>\n\t\t<a id="promisingLink" href="#/issue/${e}/promising">Prometedoras</a>\n\t\t<a id="bestLink" href="#/issue/${e}/best">Mejores</a>\n\t\t<a id="consolidatedLink" href="#/issue/${e}/consolidated">Consolidadas</a>\n\t</section>\n\t<section class='posts-box'>\n\t\t<form class='post-form' onsubmit="postAnswer(this, '${e}'); return false">\n\t\t\t<textarea class='post-input' name="answerText" rows=4 oninput="while (this.offsetHeight <= this.scrollHeight) this.rows += 4"\n\t\t\t\tplaceholder="Propón una nueva respuesta..." required></textarea>\n\t\t\t<input class="propose-button" type="submit" value="Proponer">\n\t\t</form>\n\t</section>`,document.getElementById(t+"Link").style.fontWeight="bold";let s=document.querySelector(".order-bar");get("/issue/"+e,isSignedIn()).then((t=>{document.title=`${t.content} - Ranking bayesianos`,s.insertAdjacentHTML("beforebegin",`<section class='posts-box'>\n\t\t\t<article>\n\t\t\t\t<p class='post-content'></p>\n\t\t\t\t<p class='post-info'></p>\n\t\t\t\t<section class='voting-box'>\n\t\t\t\t\t<p class='positive'><a class='positive' href="javascript:void(0)">A favor</a> (<span name='trues'>${t.trues}</span>)</p>\n\t\t\t\t\t<p class='negative'><a class='negative' href="javascript:void(0)">En contra</a> (<span name='falses'>${t.falses}</span>)</p>\n\t\t\t\t\t<p>Puntuación: <span name='score'>${t.score.toFixed()}</span></p>\n\t\t\t\t</section>\n\t\t\t</article>\n\t\t</section>`);let o=s.previousSibling.querySelector("article");o.issueid=e;let n=o.querySelector(".post-content"),r=o.querySelector(".post-info");n.textContent=t.content,r.textContent=`${moment(t.created_at).fromNow()} por ${t.username}`,n.offsetHeight<n.scrollHeight&&n.insertAdjacentHTML("afterend",'<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver más</a><p>'),r.offsetHeight<r.scrollHeight&&r.insertAdjacentHTML("afterend",'<p><a href="javascript:void(0)" onclick="seeMore(this.parentNode)">Ver más</a><p>'),setLinks(o,t.vote),setColors(o,t.score)})).catch(errorHandler),loadAnswers(e,t,o)}function loadURI(e){let t=location.hash.split("/"),o=e&&e.state&&e.state.offset||0;t.length>2?"new"==t[3]||"promising"==t[3]||"best"==t[3]||"consolidated"==t[3]?loadIssue(t[2],t[3],o):loadIssue(t[2],void 0,o):"new"==t[1]||"promising"==t[1]||"best"==t[1]||"consolidated"==t[1]?loadIssues(t[1],o):loadIssues(void 0,o)}function onLogin(){loadUser(),loadURI()}document.addEventListener("click",(function(e){"a"==e.target.nodeName.toLowerCase()&&e.target.href.startsWith(location.origin)&&goTo(e.target.href,e)})),window.onpopstate=loadURI,localStorage.cookie?signIn().then((()=>{document.querySelector(".default-msg")&&loadURI()})).catch((()=>{localStorage.removeItem("cookie"),document.querySelector(".default-msg")&&loadURI()})):document.querySelector(".default-msg")&&loadURI();